name: Build Windows 32-bit Compatible

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-32bit-legacy:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install dependencies
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW32
        update: true
        install: >-
          unzip
          make
          git
          mingw-w64-i686-gcc
          mingw-w64-i686-glew
          mingw-w64-i686-SDL2
          mingw-w64-i686-SDL
          python3
          zip
    
    - name: Check ROM
      run: |
        if [ ! -f "baserom.us.z64" ]; then
          echo "ERROR: baserom.us.z64 no encontrado"
          exit 1
        fi
        sha1sum baserom.us.z64
    
    - name: Disable mapfile
      run: |
        sed -i 's/^\t@\$(PYTHON) tools\/clean_mapfile.py/\t@echo "Skipping mapfile"/' Makefile
    
    - name: Apply 32-bit compatibility patches
      run: |
        echo "Aplicando parches de compatibilidad para 32-bit..."
        
        # Aumentar stack size para evitar crashes
        sed -i 's/-Wl,--stack,/&8388608,/' Makefile 2>/dev/null || true
        
        # Deshabilitar optimizaciones agresivas que causan problemas
        export CFLAGS="-O1 -fno-strict-aliasing"
        export OPTIMIZATION_FLAGS="-O1"
    
    - name: Build with maximum compatibility
      run: |
        echo "Compilando con configuracion conservadora..."
        make \
          TARGET_BITS=32 \
          DISCORD_SDK=0 \
          COOPNET=0 \
          RENDER_API=GL_LEGACY \
          WINDOW_API=SDL1 \
          DEBUG=0 \
          OPTIMIZATION_FLAGS="-O1" \
          EXTRA_CPP_FLAGS="-DLEGACY_MODE=1" \
          -j2 || true
        
        if [ -f "build/us_pc/sm64coopdx.exe" ]; then
          echo "Build completado"
          exit 0
        else
          echo "Intentando build alternativo..."
          make clean
          make \
            TARGET_BITS=32 \
            DISCORD_SDK=0 \
            COOPNET=0 \
            RENDER_API=GL \
            WINDOW_API=SDL2 \
            DEBUG=1 \
            -j2 || true
          
          if [ -f "build/us_pc/sm64coopdx.exe" ]; then
            echo "Build alternativo exitoso"
            exit 0
          else
            exit 1
          fi
        fi
    
    - name: Strip executable
      run: |
        i686-w64-mingw32-strip build/us_pc/sm64coopdx.exe
        ls -lh build/us_pc/sm64coopdx.exe
    
    - name: Copy ALL required DLLs
      run: |
        cd build/us_pc
        
        # DLLs bÃ¡sicas
        cp /mingw32/bin/SDL2.dll . 2>/dev/null || true
        cp /mingw32/bin/SDL.dll . 2>/dev/null || true
        cp /mingw32/bin/glew32.dll .
        cp /mingw32/bin/libgcc_s_dw2-1.dll .
        cp /mingw32/bin/libstdc++-6.dll .
        cp /mingw32/bin/libwinpthread-1.dll .
        
        # DLLs adicionales
        cp /mingw32/bin/zlib1.dll . 2>/dev/null || true
        cp /mingw32/bin/libiconv-2.dll . 2>/dev/null || true
        cp /mingw32/bin/libintl-8.dll . 2>/dev/null || true
        
        echo "DLLs copiadas:"
        ls -lh *.dll
    
    - name: Create compatibility config
      run: |
        cd build/us_pc
        cat > sm64config.txt << 'EOF'
fullscreen 0
window_x 640
window_y 480
vsync 1
texture_filtering 1
master_volume 50
music_volume 40
sfx_volume 50
env_volume 50
EOF
        echo "Archivo de configuracion creado"
    
    - name: Create launcher script
      run: |
        cd build/us_pc
        cat > EJECUTAR.bat << 'EOF'
@echo off
echo ====================================
echo SM64 Coop Deluxe - Launcher 32-bit
echo ====================================
echo.
echo Verificando sistema...

REM Verificar que estamos en 32-bit
if "%PROCESSOR_ARCHITECTURE%"=="x86" (
    echo [OK] Sistema de 32-bit detectado
) else (
    echo [ADVERTENCIA] Este ejecutable es para 32-bit
    echo Tu sistema es de 64-bit, considera usar la version 64-bit
    pause
)

echo.
echo Configurando compatibilidad...
echo.

REM Establecer prioridad normal
start /NORMAL /B sm64coopdx.exe

if errorlevel 1 (
    echo.
    echo ====================================
    echo ERROR: El juego crasheo
    echo ====================================
    echo.
    echo Posibles soluciones:
    echo 1. Instala Visual C++ Redistributable x86
    echo 2. Actualiza drivers de graficos
    echo 3. Ejecuta como administrador
    echo 4. Desactiva antivirus
    echo.
    pause
)
EOF
        unix2dos EJECUTAR.bat 2>/dev/null || true
    
    - name: Create README
      run: |
        cd build/us_pc
        cat > LEEME.txt << 'EOF'
================================================================
   Super Mario 64 Coop Deluxe - Windows 32-bit
   Version de compatibilidad para PCs antiguos
================================================================

REQUISITOS MINIMOS:
- Windows XP SP3 / Vista / 7 / 8 / 10 (32-bit)
- 512 MB RAM
- OpenGL 2.1 o superior
- DirectX 9.0c

INSTALACION:

1. Instala Visual C++ Redistributable 2015-2022 (x86):
   https://aka.ms/vs/17/release/vc_redist.x86.exe

2. Extrae todos los archivos en una carpeta

3. Ejecuta: EJECUTAR.bat
   (O directamente: sm64coopdx.exe)

SOLUCION DE PROBLEMAS:

PROBLEMA: El juego crashea inmediatamente
SOLUCION: 
  - Instala VC++ Redistributable x86
  - Ejecuta como administrador
  - Actualiza drivers de video

PROBLEMA: Pantalla negra
SOLUCION:
  - Verifica que tu GPU soporte OpenGL 2.1
  - Actualiza drivers de video
  - Prueba modo ventana (edita sm64config.txt)

PROBLEMA: Muy lento / lag
SOLUCION:
  - Reduce la resolucion en sm64config.txt
  - Cierra otros programas
  - Desactiva vsync en opciones

PROBLEMA: Error de DLL faltante
SOLUCION:
  - Todas las DLLs deben estar en la misma carpeta
  - Reinstala VC++ Redistributable

CONFIGURACION:

Edita sm64config.txt para cambiar:
- Resolucion (window_x y window_y)
- Pantalla completa (fullscreen 0 o 1)
- Vsync (vsync 0 o 1)
- Volumen

NOTAS IMPORTANTES:

- Esta version usa OpenGL Legacy para maxima compatibilidad
- Discord Rich Presence esta deshabilitado
- Multiplayer online esta deshabilitado en esta version
- Algunos mods pueden no funcionar

ESPECIFICACIONES TECNICAS:

- Arquitectura: x86 (32-bit)
- Render API: OpenGL Legacy
- Window API: SDL
- Optimizacion: Conservadora (-O1)
- Discord SDK: Deshabilitado
- CoopNet: Deshabilitado

Si tienes una PC de 64-bit, usa la version 64-bit
para mejor rendimiento y estabilidad.

================================================================
EOF
        unix2dos LEEME.txt 2>/dev/null || true
    
    - name: Zip the game
      run: |
        cd ./build/us_pc
        zip -r sm64coopdx_Windows_32bit_Legacy.zip \
          dynos \
          lang \
          mods \
          palettes \
          res \
          sm64coopdx.exe \
          *.dll \
          *.bat \
          *.txt
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: sm64coopdx-windows-32bit-legacy
        path: ./build/us_pc/sm64coopdx_Windows_32bit_Legacy.zip
        retention-days: 30
