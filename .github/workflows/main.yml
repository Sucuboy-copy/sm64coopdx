name: Build Windows 32-bit

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-windows-32bit:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: MINGW32
        update: true
        install: mingw-w64-i686-gcc mingw-w64-i686-glew mingw-w64-i686-SDL2 make git python3 unzip
    
    - name: Check ROM
      shell: msys2 {0}
      run: |
        if [ ! -f "baserom.us.z64" ]; then
          echo "ERROR: baserom.us.z64 no encontrado"
          exit 1
        fi
        echo "ROM encontrada"
        sha1sum baserom.us.z64
    
    - name: Compile sm64coopdx
      shell: msys2 {0}
      run: |
        echo "Compilando para Windows 32-bit..."
        make TARGET_BITS=32 DISCORD_SDK=0 -j4
    
    - name: Package build
      shell: msys2 {0}
      run: |
        echo "Empaquetando archivos..."
        mkdir -p sm64coopdx-win32
        cp build/us_pc/sm64coopdx.exe sm64coopdx-win32/
        cp -r res sm64coopdx-win32/
        cp -r lang sm64coopdx-win32/
        if [ -d "mods" ]; then cp -r mods sm64coopdx-win32/; fi
        
        echo "Copiando DLLs necesarias..."
        cp /mingw32/bin/SDL2.dll sm64coopdx-win32/ 2>/dev/null || echo "SDL2.dll no encontrado"
        cp /mingw32/bin/glew32.dll sm64coopdx-win32/ 2>/dev/null || echo "glew32.dll no encontrado"
        cp /mingw32/bin/libgcc_s_dw2-1.dll sm64coopdx-win32/ 2>/dev/null || echo "libgcc no encontrado"
        cp /mingw32/bin/libstdc++-6.dll sm64coopdx-win32/ 2>/dev/null || echo "libstdc++ no encontrado"
        cp /mingw32/bin/libwinpthread-1.dll sm64coopdx-win32/ 2>/dev/null || echo "libwinpthread no encontrado"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: sm64coopdx-windows-32bit
        path: sm64coopdx-win32/
        retention-days: 30
